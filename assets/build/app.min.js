/**
 * @name Aroskanalen
 * @version v3.3.0
 * @link https://github.com/aroskanalen/screen
 */
angular.module("ikApp",["ngAnimate","angular.css.injector","itkLog","itkRegion","itkDateComponent","itkDigitalClockComponent","itkKeypress"]).config(["$sceDelegateProvider",function(e){"use strict";e.resourceUrlWhitelist(["self","**"])}]).config(["$provide",function(e){"use strict";e.decorator("$exceptionHandler",["$delegate","$injector",function(e,n){return function(t,i){e(t,i),n.get("itkLog").error(t,i)}}])}]),angular.module("ikApp").controller("IndexController",["$scope","$rootScope","$timeout","socket","itkLog","cssInjector",function(e,n,t,i,o,r){"use strict";e.template="app/pages/index/init.html?"+window.config.version,e.running=!1,e.fallbackImageUrl=window.config.fallback_image?window.config.fallback_image:"assets/images/fallback_default.png";var a=[],s=[];e.displayFallbackImage=!0,n.$on("regionInfo",function(n,t){s[t.id]=t;var i=!1;s.forEach(function(e){e.scheduledSlides>0&&(i=!0)}),e.displayFallbackImage=!i}),n.$on("activationNotComplete",function(){e.$apply(function(){e.template="app/pages/notActivated/not-activated.html?"+window.config.version})}),n.$on("awaitingContent",function(){e.$apply(function(){e.template="app/pages/index/awaiting-content.html?"+window.config.version})}),n.$on("start",function(i,s){e.running||(e.$apply(function(){r.add(s.template.path_css),e.template=s.template.path_live,e.templateDirectory=s.template.path,e.options=s.options}),t(function(){e.running=!0;for(var t=0;t<a.length;t++)o.info("emitting channel saved channel."),n.$emit("addChannel",a[t])},5e3))}),n.$on("addChannel",function(n,t){e.running||(o.info("saving channel till screen is ready."),a.push(t))}),e.logout=function(){i.logout()},i.start()}]),angular.module("ikApp").controller("NotActivatedController",["$scope","socket",function(e,n){"use strict";e.activationCode="",e.submitActivationCode=function(){n.activateScreenAndConnect(e.activationCode)}}]),angular.module("ikApp").filter("activeEvents",function(){return function(e){"use strict";if(!angular.isArray(e))return!1;for(var n=parseInt(Date.now()/1e3),t=[],i=0;i<e.length;i++){var o=e[i];o.from&&o.to&&o.to>=n?t.push(o):o.from&&o.from>=n&&t.push(o)}return t}}),function(){"use strict";var e;e=angular.module("itkRegion",[]),e.directive("region",["$rootScope","$timeout","$interval","itkLog","$http","$sce",function(e,n,t,i,o,r){return{restrict:"E",scope:{regionId:"=",showProgress:"=",scale:"="},templateUrl:"app/shared/region/region.html?"+window.config.version,link:function(a){e.$broadcast("regionInfo",{id:a.regionId,scheduledSlides:0}),a.channels=[{},{}],a.channelKeys=[[],[]];var s=-1;a.slideIndex=null,a.channelIndex=null,a.displayIndex=0,a.running=!1,a.slidesUpdated=!1;var c=null,d=1e3;a.progressBoxElements=0,a.progressBoxElementsIndex=0;var l=function(e){a.progressBarStyle={overflow:"hidden","-webkit-transition":"width "+e+"s linear","-moz-transition":"width "+e+"s linear","-o-transition":"width "+e+"s linear",transition:"width "+e+"s linear",width:"100%"}},u=function(){a.progressBarStyle={width:"0"}},f=function(){i.info("resetProgressBox"),a.progressBoxElements=0,a.progressBoxElementsIndex=0;for(var n=0,t=0;t<a.channelKeys[a.displayIndex].length;t++){var o=a.channelKeys[a.displayIndex][t],r=a.channels[a.displayIndex][o];if(r.isScheduled)for(var s=0;s<r.slides.length;s++){var c=r.slides[s];c.isScheduled&&n++}}a.progressBoxElements=n,e.$broadcast("regionInfo",{id:a.regionId,scheduledSlides:n})},p=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.schedule_from,i=e.schedule_to,o=t&&0!==t,r=i&&0!==i;return o&&!r?n>t:o&&r?i>t&&n>t&&i>n:!o&&r?i>n:!0},h=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.publish_from,i=e.publish_to;return t||i?t&&n>t&&(!i||i>n)?!0:!t&&i>n:!0},g=function(e){if(!e.schedule_repeat)return!0;var n=new Date,t=n.getDay(),i=n.getHours(),o=e.schedule_repeat_from,r=e.schedule_repeat_to,a=e.schedule_repeat_days;if(!o&&!r&&0===a.length)return!0;for(var s=!1,c=0;c<a.length;c++)if(a[c].id===t){s=!0;break}return s?o>r?!1:i>=o&&r>i:!1},v=function(){a.channelKeys[a.displayIndex].forEach(function(e){var n=a.channels[a.displayIndex][e];n.isScheduled=h(n)&&g(n)})},m=function(){a.channelKeys[a.displayIndex].forEach(function(e){var n=a.channels[a.displayIndex][e];n.slides.forEach(function(e){e.isScheduled=p(e)})})},y=function(){for(var e,n=0;n<a.channelKeys[a.displayIndex].length;n++){var t=a.channelKeys[a.displayIndex][n],i=a.channels[a.displayIndex][t];if(i.isScheduled)for(var o=0;o<i.slides.length;o++)if(e=i.slides[o],e.isScheduled)return!0}return!1},w=function(){i.info("restart show");var e=(a.displayIndex+1)%2;a.slideIndex=-1,s=-1,a.slidesUpdated&&(a.channels[a.displayIndex]=angular.copy(a.channels[e]),a.channelKeys[a.displayIndex]=Object.keys(a.channels[a.displayIndex]),a.displayIndex=e,a.slidesUpdated=!1),v(),m(),f(),y()?x():(n.cancel(c),c=n(k,5e3))},k=function(){w()},I=function(){x()},x=function C(){if(i.info("next channel"),s++,s<a.channelKeys[a.displayIndex].length){var e=a.channelKeys[a.displayIndex][s],C=a.channels[a.displayIndex][e];C.isScheduled?(a.channelIndex=e,a.slideIndex=-1,$()):(n.cancel(c),n(I,100))}else w()},$=function b(){i.info("next slide");var e=a.slideIndex+1;if(!a.channels[a.displayIndex][a.channelIndex]||e>=a.channels[a.displayIndex][a.channelIndex].slides.length)return void x();if(void 0===a.channels[a.displayIndex][a.channelIndex]||a.channels[a.displayIndex][a.channelIndex].slides.length<=0)return n.cancel(c),void(c=n(b,5e3));a.slideIndex=e;var t=a.channels[a.displayIndex][a.channelIndex].slides[a.slideIndex];t.isScheduled?S():y()?(i.info("Slide schedule: slides remain."),b()):(i.info("Slide schedule: slides do not remain"),n.cancel(c),n(function(){w()},5e3))},S=function(){n.cancel(c),u(),a.progressBoxElementsIndex++;var e=a.channels[a.displayIndex][a.channelIndex].slides[a.slideIndex];return void 0===e?(i.info("No slides yet... waiting 5 seconds"),void n(function(){S()},5e3)):void(window.slideFunctions[e.js_script_id]?window.slideFunctions[e.js_script_id].run(e,$,o,n,t,r,i,l,d):window.slideFunctions["null"].run(e,$,o,n,t,r,i,l,d))},_=function(e){var n=(a.displayIndex+1)%2,t=""+e.id;a.channels[n][t]=angular.copy(e),a.channelKeys[n]=Object.keys(a.channels[n]),a.slidesUpdated=!0};e.$on("addChannel",function(e,t){if(null!==t){if(-1===t.regions.indexOf(a.regionId)){var o=(a.displayIndex+1)%2,r=""+t.data.id;return void(a.channels[o].hasOwnProperty(r)&&(i.info("Removing channel "+t.data.id+" from region "+a.regionId),delete a.channels[o][r],a.channelKeys[o]=Object.keys(a.channels[o]),a.slidesUpdated=!0))}i.info("Adding channel "+t.data.id+" to region "+a.regionId),a.running?_(t.data):a.$apply(function(){a.running=!0;var e=""+t.data.id;a.channels[0][e]=angular.copy(t.data),a.channels[1][e]=angular.copy(t.data),a.channelKeys[0]=Object.keys(a.channels[0]),a.channelKeys[1]=Object.keys(a.channels[1]),s=-1,n(function(){a.slideIndex=-1,a.running=!0,v(),m(),f(),x()},1e3)})}}),e.$on("removeChannel",function(e,n){var t=(a.displayIndex+1)%2,i=""+n.id;a.channels[t].hasOwnProperty(i)&&(delete a.channels[t][i],a.channelKeys[t]=Object.keys(a.channels[t]),a.slidesUpdated=!0)})}}}])}.call(this),window.slideFunctions||(window.slideFunctions=[]),window.slideFunctions["null"]||(window.slideFunctions["null"]={setup:function(e,n){e.lastRefresh=0,e.getRefreshedSource=function(){var n=(new Date).getTime();return n-e.lastRefresh>3e4&&(e.lastRefresh=n),e.options.source.indexOf("?")>0?e.options.source+"&ikrefresh="+e.lastRefresh:e.options.source+"?ikrefresh="+e.lastRefresh},"image"===e.media_type&&e.media.length>0?e.currentImage=e.media[0].image:"video"===e.media_type&&e.media.length>0&&(e.currentVideo={mp4:e.media[0].mp4,ogg:e.media[0].ogv,webm:e.media[0].webm}),e.currentLogo=e.logo,n.theStyle={width:"100%",height:"100%",fontsize:e.options.fontsize*(n.scale?n.scale:1)+"px"},e.options.responsive_fontsize&&(n.theStyle.responsiveFontsize=e.options.responsive_fontsize*(n.scale?n.scale:1)+"vw")},run:function(e,n,t,i,o,r,a,s,c){var d=function(e,n){for(var t=e.getElementsByTagName("source"),i=0;i<t.length;i++)n?(e.pause(),t[i].setAttribute("src",""),e.load()):t[i].setAttribute("src",t[i].getAttribute("data-src"))},l=function h(e){void 0!==e?(e.target.removeEventListener(e.type,h),a.error("Network connection.",e)):a.error("Unknown video network connection error."),Offline.off("down"),n()};if("video"===e.media_type){if(e.media.length<=0&&n(),Offline.on("down",l),Offline.check(),"down"===Offline.state)return void l(void 0);var u=document.getElementById("videoPlayer-"+e.uniqueId);d(u,!1),u.addEventListener("error",l);try{u.load(),u.currentTime=0}catch(f){a.info("Video content might not be loaded, so reset current time not possible"),l(void 0)}i(function(){var e=o(function(){if(u.readyState>0){var n=Math.round(u.duration);s(n),o.cancel(e)}},500);u.onended=function(e){a.info("Video playback ended.",e),i(function(){scope.$apply(function(){u.removeEventListener("error",l),Offline.off("down"),d(u,!0),n()})},1e3)},u.play()},c)}else{var p=e.duration?e.duration:5;i(function(){s(p),i(function(){n()},1e3*p+c)},c)}}}),angular.module("ikApp").directive("slide",["cssInjector",function(e){"use strict";return{restrict:"E",scope:{ikSlide:"=",show:"=",arrayId:"=",channelId:"=",index:"=",regionId:"=",scale:"="},link:function(n,t,i){n.ikSlide.uniqueId=null,i.$observe("regionId",function(e){e&&(n.ikSlide.uniqueId=""+n.regionId+"-"+n.arrayId+"-"+n.channelId+"-"+n.index)}),i.$observe("ikSlide",function(t){t&&(window.slideFunctions[n.ikSlide.js_script_id]?n.ikSlide.js_path&&window.slideFunctions[n.ikSlide.js_path]?window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n):window.slideFunctions["null"].setup(n.ikSlide,n):$.getScript(n.ikSlide.js_path,function(){window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n)}),e.add(n.ikSlide.css_path))})},template:'<div data-ng-include="ikSlide.template_path"></div>'}}]),angular.module("ikApp").factory("socket",["$rootScope","itkLog",function(e,n){"use strict";var t,i,o={},r=window.config,a=!1,s=function(){var e=function(e){var n=this;n.get=function(){var n=new RegExp("(?:^"+e+"|s*"+e+")=(.*?)(?:;|$)","g"),t=n.exec(document.cookie);return null===t?void 0:t[1]},n.set=function(n,t){var i=e+"="+escape(n)+";";void 0===t&&(t="Thu, 01 Jan 2018 00:00:00 GMT"),i+="expires="+t+";",i+="path=/;",i+="domain="+document.domain+";",r.cookie.secure===!0&&(i+=" secure"),document.cookie=i},n.remove=function(){n.set("","Thu, 01 Jan 1970 00:00:00 GMT")}};return e}(),c=function(){i=new s("indholdskanalen_token");var n=i.get();void 0===n?e.$emit("activationNotComplete"):l(n)},d=function u(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",r.resource.server+r.resource.uri+"/socket.io/socket.io.js"),t.onload=function(){"undefined"==typeof io?(n.error("Socket.io not loaded"),document.getElementsByTagName("head")[0].removeChild(t),window.setTimeout(u(e),100)):e()},document.getElementsByTagName("head")[0].appendChild(t)},l=function(o){t=io.connect(r.ws.server,{query:"token="+o,"force new connection":!0,"max reconnection attempts":1/0,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),t.on("connect",function(){i.set(o),n.log("Connection to middleware"),a||(a=!0),t.emit("ready")}),t.on("booted",function(e){i.remove(),location.reload(!0)}),t.on("channelRemoved",function(n){e.$emit("removeChannel",n)}),t.on("error",function(e){n.error(e)}),t.on("disconnect",function(){n.info("disconnect")}),t.on("reconnect",function(){n.info("reconnect")}),t.on("reconnect_attempt",function(){n.info("reconnect_attempt")}),t.on("connect_error",function(){n.error("connect_error")}),t.on("reconnect_error",function(){n.error("reconnect_error")}),t.on("reconnect_failed",function(){n.error("reconnect_failed")}),t.on("ready",function(t){e.$emit("start",t.screen),200!==t.statusCode?404!==t.statusCode&&n.error("Code: "+t.statusCode+" - Connection error"):a||e.$emit("awaitingContent",{})}),t.on("reload",function(e){location.reload(!0)}),t.on("channelPush",function(n){e.$emit("addChannel",n)}),e.$on("logout",function(){t.emit("logout")})};return o.start=function(){d(function(){return c()})},o.logout=function(){e.$emit("logout"),i.remove(),location.reload(!0)},o.activateScreenAndConnect=function f(t){var i=new XMLHttpRequest;i.open("POST",r.resource.server+r.resource.uri+"/screen/activate",!0),i.setRequestHeader("Content-Type","application/json"),i.onload=function(o){if(4==i.readyState&&200==i.status)o=JSON.parse(i.responseText),l(o.token);else if(4==i.readyState&&409==i.status){o=JSON.parse(i.responseText);var a=confirm(o.message);if(1==a){var s=new XMLHttpRequest;s.open("POST",r.resource.server+r.resource.uri+"/screen/kick",!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Authorization","Bearer "+o.token),s.onload=function(e){f(t)},s.onerror=function(t){e.$apply(function(){n.error("Kick request failed.",t)})},s.send(JSON.stringify({token:o.token}))}}else e.$apply(function(){n.error(i.responseText,i)})},i.onerror=function(t){e.$apply(function(){n.error("Activation request failed.",t)})},i.send(JSON.stringify({activationCode:t,apikey:r.apikey}))},o}]),function(){"use strict";var e;e=angular.module("itkDateComponent",[]),e.directive("dateComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/date/date.html?"+window.config.version,scope:{theme:"@"},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=new Date},6e4);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e;e=angular.module("itkDigitalClockComponent",[]),e.directive("digitalClockComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/digital-clock/digital-clock.html?"+window.config.version,scope:{},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=Date.now()},1e3);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e,n=!1;e=angular.module("itkKeypress",[]),e.directive("itkKeypress",function(){return function(e,t,i){t.bind("keydown keypress",function(t){return t.which===Number(i.modifier)?void(n=!0):(n&&t.which===Number(i.key)&&(e.$apply(function(){e.$eval(i.itkKeypress)}),t.preventDefault()),void(n=!1))})}})}.call(this);