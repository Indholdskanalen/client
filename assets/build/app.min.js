/**
 * @name Aroskanalen
 * @version v3.3.0
 * @link https://github.com/aroskanalen/screen
 */
angular.module("ikApp",["ngAnimate","angular.css.injector","itkLog","itkRegion","itkDateComponent","itkDigitalClockComponent","itkKeypress"]).config(["$sceDelegateProvider",function(e){"use strict";e.resourceUrlWhitelist(["self","**"])}]).config(["$provide",function(e){"use strict";e.decorator("$exceptionHandler",["$delegate","$injector",function(e,n){return function(t,o){e(t,o),n.get("itkLog").error(t,o)}}])}]),angular.module("ikApp").controller("NotActivatedController",["$scope","socket",function(e,n){"use strict";e.activationCode="",e.submitActivationCode=function(){n.activateScreenAndConnect(e.activationCode)}}]),angular.module("ikApp").filter("activeEvents",function(){"use strict";return function(e){if(!angular.isArray(e))return!1;for(var n=parseInt(Date.now()/1e3),t=[],o=0;o<e.length;o++){var i=e[o];i.from&&i.to&&i.to>=n?t.push(i):i.from&&i.from>=n&&t.push(i)}return t}}),function(){"use strict";function e(e,n){this.scope=e,this.itkLog=n}function n(e,n,t,o,i,s,r,a){this.scope=e,this.itkLog=n,this.progressBar=t,this.$timeout=o,this.$rootScope=i,this.$http=s,this.$interval=r,this.$sce=a,this.fadeTime=1e3,this.channelKey=-1,this.timeout=null}var t=angular.module("itkRegion",[]);e.prototype.start=function(e){this.scope.progressBarStyle={overflow:"hidden","-webkit-transition":"width "+e+"s linear","-moz-transition":"width "+e+"s linear","-o-transition":"width "+e+"s linear",transition:"width "+e+"s linear",width:"100%"}},e.prototype.resetBox=function(){var e=this;e.itkLog.info("resetProgressBox"),e.scope.progressBoxElements=0,e.scope.progressBoxElementsIndex=0;for(var n=0,t=0;t<e.scope.channelKeys[e.scope.displayIndex].length;t++){var o=e.scope.channelKeys[e.scope.displayIndex][t],i=e.scope.channels[e.scope.displayIndex][o];if(i.isScheduled)for(var s=0;s<i.slides.length;s++){var r=i.slides[s];r.isScheduled&&n++}}return e.scope.progressBoxElements=n,n},e.prototype.next=function(){this.reset(),this.scope.progressBoxElementsIndex++},e.prototype.reset=function(){this.scope.progressBarStyle={width:"0"}},n.prototype.broadcastInfo=function(e){var n=this;n.$rootScope.$broadcast("regionInfo",{id:n.scope.regionId,scheduledSlides:e})},n.prototype.isSlideScheduled=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.schedule_from,o=e.schedule_to,i=t&&0!==t,s=o&&0!==o;i&&!s?e.isScheduled=n>t:i&&s?e.isScheduled=o>t&&n>t&&o>n:!i&&s?e.isScheduled=o>n:e.isScheduled=!0},n.prototype.isChannelScheduled=function(e){if(!e.schedule_repeat)return!0;var n=new Date,t=n.getDay(),o=n.getHours(),i=e.schedule_repeat_from,s=e.schedule_repeat_to,r=e.schedule_repeat_days;if(!i&&!s&&0===r.length)return!0;for(var a=!1,c=0;c<r.length;c++)if(r[c].id===t){a=!0;break}return a?i>s?!1:o>=i&&s>o:!1},n.prototype.isChannelPublished=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.publish_from,o=e.publish_to;e.isScheduled=!1,this.isChannelScheduled(e)&&(t||o?t&&n>t&&(!o||o>n)?e.isScheduled=!0:e.isScheduled=!t&&o>n:e.isScheduled=!0)},n.prototype.updateScheduling=function(){var e=this,n=e.scope.displayIndex;e.scope.channelKeys[n].forEach(function(t,o,i){var s=e.scope.channels[n][t];e.isChannelPublished(s),s.slides.forEach(function(n){e.isSlideScheduled(n)})})},n.prototype.slidesRemainToBeShown=function(){for(var e,n=this,t=n.scope.displayIndex,o=n.scope.channelKeys[n.scope.displayIndex].length,i=0;o>i;i++){var s=n.scope.channels[t][n.scope.channelKeys[t][i]];if(s.isScheduled)for(var r=0;r<s.slides.length;r++)if(e=s.slides[r],e.isScheduled)return!0}return!1},n.prototype.restartShow=function(){var e=this;if(e.itkLog.info("Restart show"),e.scope.slideIndex=-1,e.channelKey=-1,e.scope.slidesUpdated){var n=(e.scope.displayIndex+1)%2,t=e.scope.displayIndex,o=e.scope.channels;o[t]=angular.copy(o[n]),e.scope.channelKeys[t]=Object.keys(o[t]),e.scope.displayIndex=n,e.scope.slidesUpdated=!1}e.updateScheduling(),e.broadcastInfo(e.progressBar.resetBox()),e.slidesRemainToBeShown()?e.nextChannel():(e.$timeout.cancel(e.timeout),e.timeout=e.$timeout(e.restartShow,5e3))},n.prototype.nextChannel=function o(){var e=this;e.itkLog.info("Next channel"),e.channelKey++;var n=e.scope.displayIndex,t=e.scope.channelKeys;if(e.channelKey<t[n].length){var i=t[n][e.channelKey],o=e.scope.channels[n][i];o.isScheduled?(e.scope.channelIndex=i,e.scope.slideIndex=-1,e.nextSlide()):(e.$timeout.cancel(e.timeout),e.$timeout(o,100))}else e.restartShow()},n.prototype.nextSlide=function(){var e=this;e.itkLog.info("Next slide");var n=e.scope.slideIndex+1,t=e.scope.displayIndex,o=e.scope.channels,i=e.scope.channelIndex;if(!o[t][i]||n>=o[t][i].slides.length)return void e.nextChannel();if(void 0===o[t][i]||o[t][i].slides.length<=0)e.$timeout.cancel(e.timeout),e.timeout=e.$timeout(e.nextSlide,5e3);else{e.scope.slideIndex=n;var s=o[t][i].slides[t];s.isScheduled?e.displaySlide():e.slidesRemainToBeShown()?(e.itkLog.info("Slide schedule: slides remain."),e.nextSlide()):(e.itkLog.info("Slide schedule: slides do not remain"),e.$timeout.cancel(e.timeout),e.$timeout(function(){e.restartShow()},5e3))}},n.prototype.updateSlideShow=function(e){var n=this,t=(n.scope.displayIndex+1)%2,o=""+e.id;n.scope.channels[t][o]=angular.copy(e),n.scope.channelKeys[t]=Object.keys(n.scope.channels[t]),n.scope.slidesUpdated=!0},n.prototype.displaySlide=function(){var e=this;e.$timeout.cancel(e.timeout),e.progressBar.next();var n=e.scope.channels[e.scope.displayIndex][e.scope.channelIndex].slides[e.scope.slideIndex];return void 0===n?(e.itkLog.info("No slides yet... waiting 5 seconds"),void e.$timeout(function(){e.displaySlide()},5e3)):void window.slideFunctions[n.js_script_id].run(n,e)},t.directive("region",["$rootScope","$timeout","$interval","itkLog","$http","$sce",function(t,o,i,s,r,a){return{restrict:"E",scope:{regionId:"=",showProgress:"=",scale:"="},link:function(c){c.channels=[{},{}],c.channelKeys=[[],[]],c.slideIndex=null,c.channelIndex=null,c.displayIndex=0,c.running=!1,c.slidesUpdated=!1,c.progressBoxElements=0,c.progressBoxElementsIndex=0;var l=new e(c,s),d=new n(c,s,l,o,t,r,i,a);d.broadcastInfo(0),t.$on("addChannel",function(e,n){if(null!==n){if(-1===n.regions.indexOf(c.regionId)){var t=(c.displayIndex+1)%2,i=""+n.data.id;return void(c.channels[t].hasOwnProperty(i)&&(s.info("Removing channel "+n.data.id+" from region "+c.regionId),delete c.channels[t][i],c.channelKeys[t]=Object.keys(c.channels[t]),c.slidesUpdated=!0))}s.info("Adding channel "+n.data.id+" to region "+c.regionId),c.running?d.updateSlideShow(n.data):c.$apply(function(){c.running=!0;var e=""+n.data.id;c.channels[0][e]=angular.copy(n.data),c.channels[1][e]=angular.copy(n.data),c.channelKeys[0]=Object.keys(c.channels[0]),c.channelKeys[1]=Object.keys(c.channels[1]),d.channelKey=-1,o(function(){c.slideIndex=-1,c.running=!0,d.updateScheduling(),d.broadcastInfo(l.resetBox()),d.nextChannel()},1e3)})}}),t.$on("removeChannel",function(e,n){var t=(c.displayIndex+1)%2,o=""+n.id;c.channels[t].hasOwnProperty(o)&&(delete c.channels[t][o],c.channelKeys[t]=Object.keys(c.channels[t]),c.slidesUpdated=!0)})},templateUrl:"app/shared/region/region.html?"+window.config.version}}])}.call(this),angular.module("ikApp").directive("slide",["cssInjector",function(e){"use strict";return{restrict:"E",scope:{ikSlide:"=",show:"=",arrayId:"=",channelId:"=",index:"=",regionId:"=",scale:"="},link:function(n,t,o){n.ikSlide.uniqueId=null,o.$observe("regionId",function(e){e&&(n.ikSlide.uniqueId=""+n.regionId+"-"+n.arrayId+"-"+n.channelId+"-"+n.index)}),o.$observe("ikSlide",function(t){t&&(window.slideFunctions[n.ikSlide.js_script_id]?window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n):$.getScript(n.ikSlide.js_path,function(){window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n)}),e.add(n.ikSlide.css_path))})},template:'<div data-ng-include="ikSlide.template_path"></div>'}}]),angular.module("ikApp").factory("socket",["$rootScope","itkLog",function(e,n){"use strict";var t,o,i={},s=window.config,r=!1,a=function(){var e=function(e){var n=this;n.get=function(){var n=new RegExp("(?:^"+e+"|s*"+e+")=(.*?)(?:;|$)","g"),t=n.exec(document.cookie);return null===t?void 0:t[1]},n.set=function(n,t){var o=e+"="+escape(n)+";";void 0===t&&(t="Thu, 01 Jan 2018 00:00:00 GMT"),o+="expires="+t+";",o+="path=/;",o+="domain="+document.domain+";",s.cookie.secure===!0&&(o+=" secure"),document.cookie=o},n.remove=function(){n.set("","Thu, 01 Jan 1970 00:00:00 GMT")}};return e}(),c=function(){o=new a("indholdskanalen_token");var n=o.get();void 0===n?e.$emit("activationNotComplete"):d(n)},l=function u(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",s.resource.server+s.resource.uri+"/socket.io/socket.io.js"),t.onload=function(){"undefined"==typeof io?(n.error("Socket.io not loaded"),document.getElementsByTagName("head")[0].removeChild(t),window.setTimeout(u(e),100)):e()},document.getElementsByTagName("head")[0].appendChild(t)},d=function(i){t=io.connect(s.ws.server,{query:"token="+i,"force new connection":!0,"max reconnection attempts":1/0,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),t.on("connect",function(){o.set(i),n.log("Connection to middleware"),r||(r=!0),t.emit("ready")}),t.on("booted",function(e){o.remove(),location.reload(!0)}),t.on("channelRemoved",function(n){e.$emit("removeChannel",n)}),t.on("error",function(e){n.error(e)}),t.on("disconnect",function(){n.info("disconnect")}),t.on("reconnect",function(){n.info("reconnect")}),t.on("reconnect_attempt",function(){n.info("reconnect_attempt")}),t.on("connect_error",function(){n.error("connect_error")}),t.on("reconnect_error",function(){n.error("reconnect_error")}),t.on("reconnect_failed",function(){n.error("reconnect_failed")}),t.on("ready",function(t){e.$emit("start",t.screen),200!==t.statusCode?404!==t.statusCode&&n.error("Code: "+t.statusCode+" - Connection error"):r||e.$emit("awaitingContent",{})}),t.on("reload",function(e){location.reload(!0)}),t.on("channelPush",function(n){e.$emit("addChannel",n)}),e.$on("logout",function(){t.emit("logout")})};return i.start=function(){l(function(){return c()})},i.logout=function(){e.$emit("logout"),o.remove(),location.reload(!0)},i.activateScreenAndConnect=function p(t){var o=new XMLHttpRequest;o.open("POST",s.resource.server+s.resource.uri+"/screen/activate",!0),o.setRequestHeader("Content-Type","application/json"),o.onload=function(i){if(4===o.readyState&&200===o.status)i=JSON.parse(o.responseText),d(i.token);else if(4===o.readyState&&409===o.status){i=JSON.parse(o.responseText);var r=confirm(i.message);if(r===!0){var a=new XMLHttpRequest;a.open("POST",s.resource.server+s.resource.uri+"/screen/kick",!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Authorization","Bearer "+i.token),a.onload=function(e){p(t)},a.onerror=function(t){e.$apply(function(){n.error("Kick request failed.",t)})},a.send(JSON.stringify({token:i.token}))}}else e.$apply(function(){n.error(o.responseText,o)})},o.onerror=function(t){e.$apply(function(){n.error("Activation request failed.",t)})},o.send(JSON.stringify({activationCode:t,apikey:s.apikey}))},i}]),angular.module("ikApp").controller("IndexController",["$scope","$rootScope","$timeout","socket","itkLog","cssInjector",function(e,n,t,o,i,s){"use strict";window.hasOwnProperty("slideFunctions")||(window.slideFunctions=[]),e.template="app/pages/index/init.html?"+window.config.version,e.running=!1,e.fallbackImageUrl=window.config.fallback_image?window.config.fallback_image:"assets/images/fallback_default.png",e.displayFallbackImage=!0;var r=[],a=[];n.$on("regionInfo",function(n,t){a[t.id]=t;var o=!1;a.forEach(function(e){e.scheduledSlides>0&&(o=!0)}),e.displayFallbackImage=!o}),n.$on("activationNotComplete",function(){e.$apply(function(){e.template="app/pages/notActivated/not-activated.html?"+window.config.version})}),n.$on("awaitingContent",function(){e.$apply(function(){e.template="app/pages/index/awaiting-content.html?"+window.config.version})}),n.$on("start",function(o,a){e.running||(e.$apply(function(){s.add(a.template.path_css),e.template=a.template.path_live,e.templateDirectory=a.template.path,e.options=a.options}),t(function(){e.running=!0;for(var t=0;t<r.length;t++)i.info("Emitting channel saved channel."),n.$emit("addChannel",r[t])},5e3))}),n.$on("addChannel",function(n,t){e.running||(i.info("Saving channel till screen is ready."),r.push(t))}),e.logout=function(){o.logout()},o.start()}]),function(){"use strict";var e;e=angular.module("itkDateComponent",[]),e.directive("dateComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/date/date.html?"+window.config.version,scope:{theme:"@"},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=new Date},6e4);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e;e=angular.module("itkDigitalClockComponent",[]),e.directive("digitalClockComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/digital-clock/digital-clock.html?"+window.config.version,scope:{},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=Date.now()},1e3);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e,n=!1;e=angular.module("itkKeypress",[]),e.directive("itkKeypress",function(){return function(e,t,o){t.bind("keydown keypress",function(t){return t.which===Number(o.modifier)?void(n=!0):(n&&t.which===Number(o.key)&&(e.$apply(function(){e.$eval(o.itkKeypress)}),t.preventDefault()),void(n=!1))})}})}.call(this);