/**
 * @name Aroskanalen
 * @version v3.3.0
 * @link https://github.com/aroskanalen/screen
 */
angular.module("ikApp",["ngAnimate","angular.css.injector","itkLog","itkRegion","itkDateComponent","itkDigitalClockComponent","itkKeypress"]).config(["$sceDelegateProvider",function(e){"use strict";e.resourceUrlWhitelist(["self","**"])}]).config(["$provide",function(e){"use strict";e.decorator("$exceptionHandler",["$delegate","$injector",function(e,n){return function(t,i){e(t,i),n.get("itkLog").error(t,i)}}])}]),angular.module("ikApp").controller("IndexController",["$scope","$rootScope","$timeout","socket","itkLog","cssInjector",function(e,n,t,i,o,a){"use strict";window.slideFunctions||(window.slideFunctions=[]),e.template="app/pages/index/init.html?"+window.config.version,e.running=!1,e.fallbackImageUrl=window.config.fallback_image?window.config.fallback_image:"assets/images/fallback_default.png";var r=[],s=[];e.displayFallbackImage=!0,n.$on("regionInfo",function(n,t){s[t.id]=t;var i=!1;s.forEach(function(e){e.scheduledSlides>0&&(i=!0)}),e.displayFallbackImage=!i}),n.$on("activationNotComplete",function(){e.$apply(function(){e.template="app/pages/notActivated/not-activated.html?"+window.config.version})}),n.$on("awaitingContent",function(){e.$apply(function(){e.template="app/pages/index/awaiting-content.html?"+window.config.version})}),n.$on("start",function(i,s){e.running||(e.$apply(function(){a.add(s.template.path_css),e.template=s.template.path_live,e.templateDirectory=s.template.path,e.options=s.options}),t(function(){e.running=!0;for(var t=0;t<r.length;t++)o.info("emitting channel saved channel."),n.$emit("addChannel",r[t])},5e3))}),n.$on("addChannel",function(n,t){e.running||(o.info("saving channel till screen is ready."),r.push(t))}),e.logout=function(){i.logout()},i.start()}]),angular.module("ikApp").controller("NotActivatedController",["$scope","socket",function(e,n){"use strict";e.activationCode="",e.submitActivationCode=function(){n.activateScreenAndConnect(e.activationCode)}}]),angular.module("ikApp").filter("activeEvents",function(){"use strict";return function(e){if(!angular.isArray(e))return!1;for(var n=parseInt(Date.now()/1e3),t=[],i=0;i<e.length;i++){var o=e[i];o.from&&o.to&&o.to>=n?t.push(o):o.from&&o.from>=n&&t.push(o)}return t}}),function(){"use strict";var e;e=angular.module("itkRegion",[]),e.directive("region",["$rootScope","$timeout","$interval","itkLog","$http","$sce",function(e,n,t,i,o,a){return{restrict:"E",scope:{regionId:"=",showProgress:"=",scale:"="},templateUrl:"app/shared/region/region.html?"+window.config.version,link:function(r){e.$broadcast("regionInfo",{id:r.regionId,scheduledSlides:0}),r.channels=[{},{}],r.channelKeys=[[],[]];var s=-1;r.slideIndex=null,r.channelIndex=null,r.displayIndex=0,r.running=!1,r.slidesUpdated=!1;var c=null,d=1e3;r.progressBoxElements=0,r.progressBoxElementsIndex=0;var l=function(e){r.progressBarStyle={overflow:"hidden","-webkit-transition":"width "+e+"s linear","-moz-transition":"width "+e+"s linear","-o-transition":"width "+e+"s linear",transition:"width "+e+"s linear",width:"100%"}},u=function(){r.progressBarStyle={width:"0"}},p=function(){i.info("resetProgressBox"),r.progressBoxElements=0,r.progressBoxElementsIndex=0;for(var n=0,t=0;t<r.channelKeys[r.displayIndex].length;t++){var o=r.channelKeys[r.displayIndex][t],a=r.channels[r.displayIndex][o];if(a.isScheduled)for(var s=0;s<a.slides.length;s++){var c=a.slides[s];c.isScheduled&&n++}}r.progressBoxElements=n,e.$broadcast("regionInfo",{id:r.regionId,scheduledSlides:n})},f=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.schedule_from,i=e.schedule_to,o=t&&0!==t,a=i&&0!==i;return o&&!a?n>t:o&&a?i>t&&n>t&&i>n:!o&&a?i>n:!0},h=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.publish_from,i=e.publish_to;return t||i?t&&n>t&&(!i||i>n)?!0:!t&&i>n:!0},g=function(e){if(!e.schedule_repeat)return!0;var n=new Date,t=n.getDay(),i=n.getHours(),o=e.schedule_repeat_from,a=e.schedule_repeat_to,r=e.schedule_repeat_days;if(!o&&!a&&0===r.length)return!0;for(var s=!1,c=0;c<r.length;c++)if(r[c].id===t){s=!0;break}return s?o>a?!1:i>=o&&a>i:!1},v=function(){r.channelKeys[r.displayIndex].forEach(function(e){var n=r.channels[r.displayIndex][e];n.isScheduled=h(n)&&g(n)})},m=function(){r.channelKeys[r.displayIndex].forEach(function(e){var n=r.channels[r.displayIndex][e];n.slides.forEach(function(e){e.isScheduled=f(e)})})},y=function(){for(var e,n=0;n<r.channelKeys[r.displayIndex].length;n++){var t=r.channelKeys[r.displayIndex][n],i=r.channels[r.displayIndex][t];if(i.isScheduled)for(var o=0;o<i.slides.length;o++)if(e=i.slides[o],e.isScheduled)return!0}return!1},k=function(){i.info("restart show");var e=(r.displayIndex+1)%2;r.slideIndex=-1,s=-1,r.slidesUpdated&&(r.channels[r.displayIndex]=angular.copy(r.channels[e]),r.channelKeys[r.displayIndex]=Object.keys(r.channels[r.displayIndex]),r.displayIndex=e,r.slidesUpdated=!1),v(),m(),p(),y()?w():(n.cancel(c),c=n(x,5e3))},x=function(){k()},I=function(){w()},w=function C(){if(i.info("next channel"),s++,s<r.channelKeys[r.displayIndex].length){var e=r.channelKeys[r.displayIndex][s],C=r.channels[r.displayIndex][e];C.isScheduled?(r.channelIndex=e,r.slideIndex=-1,$()):(n.cancel(c),n(I,100))}else k()},$=function b(){i.info("next slide");var e=r.slideIndex+1;if(!r.channels[r.displayIndex][r.channelIndex]||e>=r.channels[r.displayIndex][r.channelIndex].slides.length)return void w();if(void 0===r.channels[r.displayIndex][r.channelIndex]||r.channels[r.displayIndex][r.channelIndex].slides.length<=0)return n.cancel(c),void(c=n(b,5e3));r.slideIndex=e;var t=r.channels[r.displayIndex][r.channelIndex].slides[r.slideIndex];t.isScheduled?S():y()?(i.info("Slide schedule: slides remain."),b()):(i.info("Slide schedule: slides do not remain"),n.cancel(c),n(function(){k()},5e3))},S=function(){n.cancel(c),u(),r.progressBoxElementsIndex++;var e=r.channels[r.displayIndex][r.channelIndex].slides[r.slideIndex];return void 0===e?(i.info("No slides yet... waiting 5 seconds"),void n(function(){S()},5e3)):void window.slideFunctions[e.js_script_id].run(e,r,$,o,n,t,a,i,l,d)},_=function(e){var n=(r.displayIndex+1)%2,t=""+e.id;r.channels[n][t]=angular.copy(e),r.channelKeys[n]=Object.keys(r.channels[n]),r.slidesUpdated=!0};e.$on("addChannel",function(e,t){if(null!==t){if(-1===t.regions.indexOf(r.regionId)){var o=(r.displayIndex+1)%2,a=""+t.data.id;return void(r.channels[o].hasOwnProperty(a)&&(i.info("Removing channel "+t.data.id+" from region "+r.regionId),delete r.channels[o][a],r.channelKeys[o]=Object.keys(r.channels[o]),r.slidesUpdated=!0))}i.info("Adding channel "+t.data.id+" to region "+r.regionId),r.running?_(t.data):r.$apply(function(){r.running=!0;var e=""+t.data.id;r.channels[0][e]=angular.copy(t.data),r.channels[1][e]=angular.copy(t.data),r.channelKeys[0]=Object.keys(r.channels[0]),r.channelKeys[1]=Object.keys(r.channels[1]),s=-1,n(function(){r.slideIndex=-1,r.running=!0,v(),m(),p(),w()},1e3)})}}),e.$on("removeChannel",function(e,n){var t=(r.displayIndex+1)%2,i=""+n.id;r.channels[t].hasOwnProperty(i)&&(delete r.channels[t][i],r.channelKeys[t]=Object.keys(r.channels[t]),r.slidesUpdated=!0)})}}}])}.call(this),angular.module("ikApp").directive("slide",["cssInjector",function(e){"use strict";return{restrict:"E",scope:{ikSlide:"=",show:"=",arrayId:"=",channelId:"=",index:"=",regionId:"=",scale:"="},link:function(n,t,i){n.ikSlide.uniqueId=null,i.$observe("regionId",function(e){e&&(n.ikSlide.uniqueId=""+n.regionId+"-"+n.arrayId+"-"+n.channelId+"-"+n.index)}),i.$observe("ikSlide",function(t){t&&(window.slideFunctions.hasOwnProperty(n.ikSlide.js_script_id)?n.ikSlide.js_path&&window.slideFunctions[n.ikSlide.js_path]&&window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n):$.getScript(n.ikSlide.js_path,function(){window.slideFunctions[n.ikSlide.js_script_id].setup(n.ikSlide,n)}),e.add(n.ikSlide.css_path))})},template:'<div data-ng-include="ikSlide.template_path"></div>'}}]),angular.module("ikApp").factory("socket",["$rootScope","itkLog",function(e,n){"use strict";var t,i,o={},a=window.config,r=!1,s=function(){var e=function(e){var n=this;n.get=function(){var n=new RegExp("(?:^"+e+"|s*"+e+")=(.*?)(?:;|$)","g"),t=n.exec(document.cookie);return null===t?void 0:t[1]},n.set=function(n,t){var i=e+"="+escape(n)+";";void 0===t&&(t="Thu, 01 Jan 2018 00:00:00 GMT"),i+="expires="+t+";",i+="path=/;",i+="domain="+document.domain+";",a.cookie.secure===!0&&(i+=" secure"),document.cookie=i},n.remove=function(){n.set("","Thu, 01 Jan 1970 00:00:00 GMT")}};return e}(),c=function(){i=new s("indholdskanalen_token");var n=i.get();void 0===n?e.$emit("activationNotComplete"):l(n)},d=function u(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",a.resource.server+a.resource.uri+"/socket.io/socket.io.js"),t.onload=function(){"undefined"==typeof io?(n.error("Socket.io not loaded"),document.getElementsByTagName("head")[0].removeChild(t),window.setTimeout(u(e),100)):e()},document.getElementsByTagName("head")[0].appendChild(t)},l=function(o){t=io.connect(a.ws.server,{query:"token="+o,"force new connection":!0,"max reconnection attempts":1/0,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),t.on("connect",function(){i.set(o),n.log("Connection to middleware"),r||(r=!0),t.emit("ready")}),t.on("booted",function(e){i.remove(),location.reload(!0)}),t.on("channelRemoved",function(n){e.$emit("removeChannel",n)}),t.on("error",function(e){n.error(e)}),t.on("disconnect",function(){n.info("disconnect")}),t.on("reconnect",function(){n.info("reconnect")}),t.on("reconnect_attempt",function(){n.info("reconnect_attempt")}),t.on("connect_error",function(){n.error("connect_error")}),t.on("reconnect_error",function(){n.error("reconnect_error")}),t.on("reconnect_failed",function(){n.error("reconnect_failed")}),t.on("ready",function(t){e.$emit("start",t.screen),200!==t.statusCode?404!==t.statusCode&&n.error("Code: "+t.statusCode+" - Connection error"):r||e.$emit("awaitingContent",{})}),t.on("reload",function(e){location.reload(!0)}),t.on("channelPush",function(n){e.$emit("addChannel",n)}),e.$on("logout",function(){t.emit("logout")})};return o.start=function(){d(function(){return c()})},o.logout=function(){e.$emit("logout"),i.remove(),location.reload(!0)},o.activateScreenAndConnect=function p(t){var i=new XMLHttpRequest;i.open("POST",a.resource.server+a.resource.uri+"/screen/activate",!0),i.setRequestHeader("Content-Type","application/json"),i.onload=function(o){if(4===i.readyState&&200===i.status)o=JSON.parse(i.responseText),l(o.token);else if(4===i.readyState&&409===i.status){o=JSON.parse(i.responseText);var r=confirm(o.message);if(r===!0){var s=new XMLHttpRequest;s.open("POST",a.resource.server+a.resource.uri+"/screen/kick",!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Authorization","Bearer "+o.token),s.onload=function(e){p(t)},s.onerror=function(t){e.$apply(function(){n.error("Kick request failed.",t)})},s.send(JSON.stringify({token:o.token}))}}else e.$apply(function(){n.error(i.responseText,i)})},i.onerror=function(t){e.$apply(function(){n.error("Activation request failed.",t)})},i.send(JSON.stringify({activationCode:t,apikey:a.apikey}))},o}]),function(){"use strict";var e;e=angular.module("itkDateComponent",[]),e.directive("dateComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/date/date.html?"+window.config.version,scope:{theme:"@"},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=new Date},6e4);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e;e=angular.module("itkDigitalClockComponent",[]),e.directive("digitalClockComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/digital-clock/digital-clock.html?"+window.config.version,scope:{},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=Date.now()},1e3);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e,n=!1;e=angular.module("itkKeypress",[]),e.directive("itkKeypress",function(){return function(e,t,i){t.bind("keydown keypress",function(t){return t.which===Number(i.modifier)?void(n=!0):(n&&t.which===Number(i.key)&&(e.$apply(function(){e.$eval(i.itkKeypress)}),t.preventDefault()),void(n=!1))})}})}.call(this);